<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>HTML5脚本编程</title>
</head>
<body>
  <iframe src="www.baidu.com" id="iframe" width="200px" height="200px" frameborder="0"></iframe>
  <script>
    /**
      # HTML5脚本编程
      ## 跨文档消息传递
      跨文档消息传送，简称为**XDM**，指的是来自不同域的页面间传递消息。

      **XDM** 的核心是 **postMessage()** 方法。都是为了同一个目的：向另一个地方传递数据。对于XDM而言，
      另一个地方指的是包含在当前页面中的`<iframe>`元素，或者由当前页面弹出的窗口。
      
      **postMessage()** 方法接收两个参数：一条消息和一个表示消息接收来自哪个域的字符串。第二个参数对保
      障安全通信非常重要，可以防止浏览器把消息发送到不安全的方法。来看下面的例子：
      ```js
      // 所有支持XDM的浏览器也支持iframe的contextWindow属性
      var iframe = document.getElementById("iframe").contentWindow;
      iframe.postMessage("A secret", "http://www.wrox.com");
      ```
      如果传给 **postMessage()** 的第二个参数是"*"，则表示可以把消息发送给来自任何域的文档，但不推荐这样做。

      接收到XDM消息时，会触发window对象的 **message** 事件。这个事件是以异步形式触发的，因此从发送消息到接收
      消息（触发接收窗口的message事件）可能要经过一段时间的延迟。触发message事件后，传递给onmessage事件对象
      包含以下三方面的重要消息。
      * **data**：作为postMessage()第一个参数传入的字符串数据。
      * **origin**：发送消息的文档所在的域，例如"http://www.wrox.com"。
      * **source**：发送消息的文档window对象代理。这个代理对象主要用于在发送上一条消息的窗口中调用
        **postMessage()** 方法。如果发送消息的窗口来自同一个域，那这个对象就是window。

      接收到消息验证发送窗口的来源是至关重要的。就像给postMessage()方法指定第二个参数，以确保浏览器不
      会把消息发送给未知页面一样，在onmessage处理程序中检测消息来源可以确保传入的消息来自己知的页面。
      基本的检测模式如下：
      ```js
      var iframe = document.getElementById("iframe").contentWindow;
      iframe.postMessage("A secret", "http://www.wrox.com");

      window.addEventListener("message", function(event) {
        // 确保发送消息的域是已知的域
        if (event.origin == "http://www.wrox.com") {
          // 处理接收到的数据
          processMessage(event.data);

          // 可选：向来源窗口发送回执
          event.source.postMessage("Received", "http://www.biadu.com");
        }
      })
      ```
      使用 **postMessage()** 时，最好还是只传字符串。如果你想传入结构化的数据，最佳选择是先在要传
      入的数据上调用 **JSON.stringify()**，通过 **postMessage()** 传入得到的字符串，然后再在
      onmessage事件中调用**JSON.parse()**。
    **/
    var iframe = document.getElementById("iframe").contentWindow;
    iframe.postMessage("A secret", "http://www.wrox.com");

    window.addEventListener("message", function(event) {
      // 确保发送消息的域是已知的域
      if (event.origin == "http://www.wrox.com") {
        // 处理接收到的数据
        processMessage(event.data);

        // 可选：向来源窗口发送回执
        event.source.postMessage("Received", "http://www.biadu.com");
      }
    })
  </script>
</body>
</html>