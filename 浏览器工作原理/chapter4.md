## 从输入 URL 到页面展示，这中间发生了什么？

### 从输入 URL 到页面展示

用户发出 URL 请求到页面开始解析这个过程，叫做导航。

#### 用户输入

在地址栏上输入一个查询关键字时，地址栏会判断输入的关键字是搜索内容还是 URL。

1. 如果是搜索内容，地址栏会使用浏览器默认的搜索引擎，合成带新搜索关键字的 URL。
2. 如果是 URL，那么地址栏会根据规则，把这段内容加上协议。合成完整的 URL。

在按下回车键之后，当前页面如果有未提交完成的表单时，会执行一次`beforeUnload`事件来取消导航。如果没有，就进行下一个阶段。这时，浏览器会进入`loading`状态，还会展示之前打开的内容，并不会立即替换到要导航的页面。因为要等待提交文档阶段，页面内容才会被替换。

#### URL 请求过程

接下来，进入页面资源请求过程。

1. 网络进程先查找缓存，如果有缓存，直接返回资源给浏览器；如果没有，就发起网络请求。发起之前进行 DNS 解析。如果请求协议是 HTTPS，还要建立 TLS 连接。

2. 利用 IP 地址和服务器建立 TCP 连接，之后，客户端构建请求行等信息，并将该域名相关的 Cookie 加到请求头中，然后向服务器发送构建的请求信息。

3. 服务器收到请求后，根据请求信息生成响应数据，发给网络进程。网络进程接收到响应头后，解析响应头内容。

4. 接收服务器返回的响应头后，网络进程解析响应头，如果返回的状态码是`301`或`302`。则需要重定向到其他 URL。网络进程从响应头获取`Location`中的地址，再发起新的请求，重头开始。

5. 如果状态码是`200`，则继续往下处理请求。

- 检查响应类型`Content-Type`，如果是字节流类型，就提交给浏览器的下载管理器。如果是 HTML，就通知浏览器进程准备渲染进程。如果服务器端配置`Content-type`不正确，例如：`text/html`配置成`application/octet-stream`，会将一个本来需要展示的页面变成一个下载文件。

接下来，准备进入准备渲染进程。

#### 准备渲染进程

每个页面都会有自己的一个渲染进程。如果是同一站点（协议、根域名、包括该域名下的所有子域名和不同端口），都会在一个渲染进程中（`process-per-site-instance`）。不同站点，则会使用一个新的渲染进程。如果从一个空白页面输入到另一个页面还是会重新分配一个渲染进程。

下一步就是提交文档。

#### 提交文档

所谓提交文档指的是，浏览器进程把网络进程收到的 HTML 数据交给渲染进程。

1. 当浏览器进程收到网络进程的响应头数据后，向渲染进程发起“提交文档”的消息。
2. 渲染进程收到消息后，和网络进程简历传输数据的“管道”。
3. 等文档数据传输完成后，渲染进程返回“确认提交”的消息给浏览器进程。
4. 浏览器进程收到“确认提交”消息后，则更新浏览器界面状态，包含安全状态、地址栏 URL、前进后退的历史状态，并更新 web 页面。

到了这里，整个导航流程就完成了，接下来就是进入渲染阶段了。
