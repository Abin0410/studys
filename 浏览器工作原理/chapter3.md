## 浏览器发起 HTTP 请求整个过程

### 构建请求

首先，浏览器会构建请求行的信息，构建好之后，准备发起请求。

### 查找缓存

在发起请求之前，浏览器会先在缓存中查询是否有要请求的文件。如果有，它会拦截请求，返回该资源的副本，并且直接结束请求，而不会去服务器重新下载。这样的好处是：

- 缓解服务器压力，提高性能（意味着获取资源耗时更短）。
- 对于网站来说，缓存是实现快速资源加载的重要组成的部分。

如果缓存查找失败，就会进行网络请求。

### 请求 DNS

浏览器会请求 DNS（域名解析服务） 返回域名对应的 IP。浏览器还提供了 DNS 数据缓存服务，如果一个域名已经解析过了，浏览器会缓存解析的结果，方便下次查询时直接使用，这样可以减少一次网络请求。

### 等待 TCP 队列

Chrome 有一个机制是，同一个域名同时最多只能建立 6 个 TCP 连接。假设，同一个域名同时有 10 个请求发生，其中 4 个请求会进入排队等待状态，直到进行中的请求完成。如果当前请求数量少于 6 个，直接进入下一步，建立 TCP 连接。

### 建立 TCP 连接

也就是三次握手。

### 发送 HTTP 请求

首先浏览器会向服务器发送**请求行**，它包括了**请求方法（GET、POST）、请求 URL 和 HTTP 版本协议**。如果使用`POST`方法的话，还要数据发送给服务器，这些数据通过**请求体**进行发送。

在浏览器发送请求行之后，还要以请求头形式发送一些其他信息，这些信息包括：浏览器所用的操作系统、浏览器内核信息，当前请求的域名信息、浏览器端的 `Cookie` 信息等等。

### 服务器端处理 HTTP 请求

#### 返回请求

一旦服务器处理结束，就返回数据给浏览器。服务器会返回响应行，包括协议版本和状态码。并不是所有的请求都会被服务器处理的，服务器会通过请求行的状态码告诉浏览器它的处理结果。

之后，服务器也会随同响应浏览器发送响应头。响应头包含以下信息：服务器生成数据的时间、返回的数据类型（`JSON`、`HTML`等类型）和服务器在客户端保存的`Cookie`等信息。

发送完响应头之后，服务器会继续发送响应体的数据。一般，响应体包含了`HTML`的实际内容。

以上就是服务器响应浏览器的过程。

#### 断开连接

服务器向客户端返回了请求数据后，就进入关闭 TCP 连接。但浏览器或服务器在头信息中会加入`Connection: Keep-Alice`。TCP 连接在发送后仍然会保存打开状态，这样浏览器可以通过同一个 TCP 连接发送请求。
保持 TCP 连接可以省去下次请求时需要建立连接的时间，提升资源加载速度。例如，一个 Web 页面中内嵌的图片都来自同一个 Web 站点，如果初始化一个持久连接，就可以复用该连接，以请求其他资源，而不需要重新建立新的 TCP 连接。

#### 重定向

还有一种情况是，如果在浏览器地址栏输入`baidu.com`，最终跳到的`https://www.baid.com`。这两个 URL 不一样是因为涉及到了重定向操作。

- 首先，服务器返回响应行和响应头。
- 重定向的的网站包含在响应头`Location`字段里。
- 浏览器获取`Location`字段的地址，并使用该地址重新导航。

### 为什么网站第二次打开速度会比第一次快？

第一次访问掘金的首页时，你会发现，加载得速度慢。当第二次访问的时候，要比第一次快得多。主要的原因是第一次加载页面的过程中，缓存了一些耗时的数据。

那么，缓存了什么数据呢？**DNS 缓存**和**页面资源缓存**是会被浏览器缓存的。

当服务器返回 HTTP 响应头给浏览器时，浏览器是通过响应头中的`Cache-Control`字段设置是否缓存该资源。另外，还要为该资源设置一个缓存过期的时长，可以通过`Cache-control`中的`Max-age`参数进行设置，以秒为单位。

这意味着，在该缓存资源未过期的情况下，如果再次请求该资源，会直接返回缓存中的资源给浏览器。

如果缓存过期了，浏览器则会发起网络请求，并在 HTTP 请求头中带上`If-None-Match:"4f80f-13c-3a1xb12a`。服务器收到后会根据`If-None-Match`的值进行判断请求的资源是否有更新。

如果没有更新，就返回`304`状态码，告诉浏览器：“这个缓存可以继续使用，这次就不重复发送数据给你了”。

如果有资源更新，服务器直接返回最新资源。

总的来说，很多网站第二次访问能达到秒开，是把资源都缓存在本地。直接从缓存中使用本地副本来回应请求，不会产生真实的网络请求，从而节省时间。DNS 数据也会被缓存，节省了 DNS 查询。

### 网页加载时间过久的原因

- 并发请求过多（超过 6 个）
- 资源过大，下载时间过长
- 重复请求资源，TCP 连接没有设置`Connection: Keep-Alice`，消耗连接时间。
- 网络慢，连接超时
- 传输丢包率高，需要不断重连。
